<style>
@font-face {
	font-family: octicons-link;
	src: url(data:font/woff;charset=utf-8;base64,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) format('woff');
}

.markdown-body {
	-ms-text-size-adjust: 100%;
	-webkit-text-size-adjust: 100%;
	line-height: 1.5;
	color: #24292e;
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
	font-size: 16px;
	line-height: 1.5;
	word-wrap: break-word;
}

.markdown-body .pl-c {
	color: #6a737d;
}

.markdown-body .pl-c1,
.markdown-body .pl-s .pl-v {
	color: #005cc5;
}

.markdown-body .pl-e,
.markdown-body .pl-en {
	color: #6f42c1;
}

.markdown-body .pl-smi,
.markdown-body .pl-s .pl-s1 {
	color: #24292e;
}

.markdown-body .pl-ent {
	color: #22863a;
}

.markdown-body .pl-k {
	color: #d73a49;
}

.markdown-body .pl-s,
.markdown-body .pl-pds,
.markdown-body .pl-s .pl-pse .pl-s1,
.markdown-body .pl-sr,
.markdown-body .pl-sr .pl-cce,
.markdown-body .pl-sr .pl-sre,
.markdown-body .pl-sr .pl-sra {
	color: #032f62;
}

.markdown-body .pl-v,
.markdown-body .pl-smw {
	color: #e36209;
}

.markdown-body .pl-bu {
	color: #b31d28;
}

.markdown-body .pl-ii {
	color: #fafbfc;
	background-color: #b31d28;
}

.markdown-body .pl-c2 {
	color: #fafbfc;
	background-color: #d73a49;
}

.markdown-body .pl-c2::before {
	content: "^M";
}

.markdown-body .pl-sr .pl-cce {
	font-weight: bold;
	color: #22863a;
}

.markdown-body .pl-ml {
	color: #735c0f;
}

.markdown-body .pl-mh,
.markdown-body .pl-mh .pl-en,
.markdown-body .pl-ms {
	font-weight: bold;
	color: #005cc5;
}

.markdown-body .pl-mi {
	font-style: italic;
	color: #24292e;
}

.markdown-body .pl-mb {
	font-weight: bold;
	color: #24292e;
}

.markdown-body .pl-md {
	color: #b31d28;
	background-color: #ffeef0;
}

.markdown-body .pl-mi1 {
	color: #22863a;
	background-color: #f0fff4;
}

.markdown-body .pl-mc {
	color: #e36209;
	background-color: #ffebda;
}

.markdown-body .pl-mi2 {
	color: #f6f8fa;
	background-color: #005cc5;
}

.markdown-body .pl-mdr {
	font-weight: bold;
	color: #6f42c1;
}

.markdown-body .pl-ba {
	color: #586069;
}

.markdown-body .pl-sg {
	color: #959da5;
}

.markdown-body .pl-corl {
	text-decoration: underline;
	color: #032f62;
}

.markdown-body .octicon {
	display: inline-block;
	vertical-align: text-top;
	fill: currentColor;
}

.markdown-body a {
	background-color: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
	outline-width: 0;
}

.markdown-body strong {
	font-weight: inherit;
}

.markdown-body strong {
	font-weight: bolder;
}

.markdown-body h1 {
	font-size: 2em;
	margin: 0.67em 0;
}

.markdown-body img {
	border-style: none;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
	font-family: monospace, monospace;
	font-size: 1em;
}

.markdown-body hr {
	box-sizing: content-box;
	height: 0;
	overflow: visible;
}

.markdown-body input {
	font: inherit;
	margin: 0;
}

.markdown-body input {
	overflow: visible;
}

.markdown-body [type="checkbox"] {
	box-sizing: border-box;
	padding: 0;
}

.markdown-body * {
	box-sizing: border-box;
}

.markdown-body input {
	font-family: inherit;
	font-size: inherit;
	line-height: inherit;
}

.markdown-body a {
	color: #0366d6;
	text-decoration: none;
}

.markdown-body a:hover {
	text-decoration: underline;
}

.markdown-body strong {
	font-weight: 600;
}

.markdown-body hr {
	height: 0;
	margin: 15px 0;
	overflow: hidden;
	background: transparent;
	border: 0;
	border-bottom: 1px solid #dfe2e5;
}

.markdown-body hr::before {
	display: table;
	content: "";
}

.markdown-body hr::after {
	display: table;
	clear: both;
	content: "";
}

.markdown-body table {
	border-spacing: 0;
	border-collapse: collapse;
}

.markdown-body td,
.markdown-body th {
	padding: 0;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
	margin-top: 0;
	margin-bottom: 0;
}

.markdown-body h1 {
	font-size: 32px;
	font-weight: 600;
}

.markdown-body h2 {
	font-size: 24px;
	font-weight: 600;
}

.markdown-body h3 {
	font-size: 20px;
	font-weight: 600;
}

.markdown-body h4 {
	font-size: 16px;
	font-weight: 600;
}

.markdown-body h5 {
	font-size: 14px;
	font-weight: 600;
}

.markdown-body h6 {
	font-size: 12px;
	font-weight: 600;
}

.markdown-body p {
	margin-top: 0;
	margin-bottom: 10px;
}

.markdown-body blockquote {
	margin: 0;
}

.markdown-body ul,
.markdown-body ol {
	padding-left: 0;
	margin-top: 0;
	margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
	x-list-style-type: lower-roman;
	  list-style-type: decimal;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
	list-style-type: lower-alpha;
}

.markdown-body dd {
	margin-left: 0;
}

.markdown-body code {
	font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
	font-size: 12px;
}

.markdown-body pre {
	margin-top: 0;
	margin-bottom: 0;
	font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
	font-size: 12px;
}

.markdown-body .octicon {
	vertical-align: text-bottom;
}

.markdown-body .pl-0 {
	padding-left: 0 !important;
}

.markdown-body .pl-1 {
	padding-left: 4px !important;
}

.markdown-body .pl-2 {
	padding-left: 8px !important;
}

.markdown-body .pl-3 {
	padding-left: 16px !important;
}

.markdown-body .pl-4 {
	padding-left: 24px !important;
}

.markdown-body .pl-5 {
	padding-left: 32px !important;
}

.markdown-body .pl-6 {
	padding-left: 40px !important;
}

.markdown-body::before {
	display: table;
	content: "";
}

.markdown-body::after {
	display: table;
	clear: both;
	content: "";
}

.markdown-body>*:first-child {
	margin-top: 0 !important;
}

.markdown-body>*:last-child {
	margin-bottom: 0 !important;
}

.markdown-body a:not([href]) {
	color: inherit;
	text-decoration: none;
}

.markdown-body .anchor {
	float: left;
	padding-right: 4px;
	margin-left: -20px;
	line-height: 1;
}

.markdown-body .anchor:focus {
	outline: none;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
	margin-top: 0;
	margin-bottom: 16px;
}

.markdown-body hr {
	height: 0.25em;
	padding: 0;
	margin: 24px 0;
	background-color: #e1e4e8;
	border: 0;
}

.markdown-body blockquote {
	padding: 0 1em;
	color: #6a737d;
	border-left: 0.25em solid #dfe2e5;
}

.markdown-body blockquote>:first-child {
	margin-top: 0;
}

.markdown-body blockquote>:last-child {
	margin-bottom: 0;
}

.markdown-body kbd {
	display: inline-block;
	padding: 3px 5px;
	font-size: 11px;
	line-height: 10px;
	color: #444d56;
	vertical-align: middle;
	background-color: #fafbfc;
	border: solid 1px #c6cbd1;
	border-bottom-color: #959da5;
	border-radius: 3px;
	box-shadow: inset 0 -1px 0 #959da5;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
	margin-top: 24px;
	margin-bottom: 16px;
	font-weight: 600;
	line-height: 1.25;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
	color: #1b1f23;
	vertical-align: middle;
	visibility: hidden;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
	text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
	visibility: visible;
}

.markdown-body h1 {
	padding-bottom: 0.3em;
	font-size: 2em;
	border-bottom: 1px solid #eaecef;
}

.markdown-body h2 {
	padding-bottom: 0.3em;
	font-size: 1.5em;
	border-bottom: 1px solid #eaecef;
}

.markdown-body h3 {
	font-size: 1.25em;
}

.markdown-body h4 {
	font-size: 1em;
}

.markdown-body h5 {
	font-size: 0.875em;
}

.markdown-body h6 {
	font-size: 0.85em;
	color: #6a737d;
}

.markdown-body ul,
.markdown-body ol {
	padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
	margin-top: 0;
	margin-bottom: 0;
}

.markdown-body li {
	word-wrap: break-all;
}

.markdown-body li>p {
	margin-top: 16px;
}

.markdown-body li+li {
	margin-top: 0.25em;
}

.markdown-body dl {
	padding: 0;
}

.markdown-body dl dt {
	padding: 0;
	margin-top: 16px;
	font-size: 1em;
	font-style: italic;
	font-weight: 600;
}

.markdown-body dl dd {
	padding: 0 16px;
	margin-bottom: 16px;
}

.markdown-body table {
	display: block;
	width: 100%;
	overflow: auto;
}

.markdown-body table th {
	font-weight: 600;
}

.markdown-body table th,
.markdown-body table td {
	padding: 6px 13px;
	border: 1px solid #dfe2e5;
}

.markdown-body table tr {
	background-color: #fff;
	border-top: 1px solid #c6cbd1;
}

.markdown-body table tr:nth-child(2n) {
	background-color: #f6f8fa;
}

.markdown-body img {
	max-width: 100%;
	box-sizing: content-box;
	background-color: #fff;
}

.markdown-body img[align=right] {
	padding-left: 20px;
}

.markdown-body img[align=left] {
	padding-right: 20px;
}

.markdown-body code {
	padding: 0.2em 0.4em;
	margin: 0;
	font-size: 85%;
	background-color: rgba(27,31,35,0.05);
	border-radius: 3px;
}

.markdown-body pre {
	word-wrap: normal;
}

.markdown-body pre>code {
	padding: 0;
	margin: 0;
	font-size: 100%;
	word-break: normal;
	white-space: pre;
	background: transparent;
	border: 0;
}

.markdown-body .highlight {
	margin-bottom: 16px;
}

.markdown-body .highlight pre {
	margin-bottom: 0;
	word-break: normal;
}

.markdown-body .highlight pre,
.markdown-body pre {
	padding: 16px;
	overflow: auto;
	font-size: 85%;
	line-height: 1.45;
	background-color: #f6f8fa;
	border-radius: 3px;
}

.markdown-body pre code {
	display: inline;
	max-width: auto;
	padding: 0;
	margin: 0;
	overflow: visible;
	line-height: inherit;
	word-wrap: normal;
	background-color: transparent;
	border: 0;
}

.markdown-body .full-commit .btn-outline:not(:disabled):hover {
	color: #005cc5;
	border-color: #005cc5;
}

.markdown-body kbd {
	display: inline-block;
	padding: 3px 5px;
	font: 11px "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
	line-height: 10px;
	color: #444d56;
	vertical-align: middle;
	background-color: #fafbfc;
	border: solid 1px #d1d5da;
	border-bottom-color: #c6cbd1;
	border-radius: 3px;
	box-shadow: inset 0 -1px 0 #c6cbd1;
}

.markdown-body :checked+.radio-label {
	position: relative;
	z-index: 1;
	border-color: #0366d6;
}

.markdown-body .task-list-item {
	list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
	margin-top: 3px;
}

.markdown-body .task-list-item input {
	margin: 0 0.2em 0.25em -1.6em;
	vertical-align: middle;
}

.markdown-body hr {
	border-bottom-color: #eee;
}

</style>
<style>
ol {
    display: block;
    list-style-type: decimal;
}
.pagebreak { page-break-before: always; }
.half { height: 200px; }
</style>

<div class="markdown-body">

<style>
.pagebreak { page-break-before: always; }
.half { height: 200px; }
</style>
<style>
.pagebreak { page-break-before: always; }
.half { height: 200px; }
.markdown-body {
    font-size: 12px;
}
.markdown-body td {
    font-size: 12px;
}
</style>

<h1>Lecture 36 - Example Contract</h1>

<p>A comparative example: An Auction Contraact</p>

<pre><code>  1: # Open Auction
  2: 
  3: # Auction params
  4: # Beneficiary receives money from the highest bidder
  5: beneficiary: public(address)
  6: auctionStart: public(uint256)
  7: auctionEnd: public(uint256)
  8: 
  9: # Current state of auction
 10: highestBidder: public(address)
 11: highestBid: public(uint256)
 12: 
 13: # Set to true at the end, disallows any change
 14: ended: public(bool)
 15: 
 16: # Keep track of refunded bids so we can follow the withdraw pattern
 17: pendingReturns: public(HashMap[address, uint256])
 18: 
 19: # Create a simple auction with `_auction_start` and
 20: # `_bidding_time` seconds bidding time on behalf of the
 21: # beneficiary address `_beneficiary`.
 22: @external
 23: def __init__(_beneficiary: address, _auction_start: uint256, _bidding_time: uint256):
 24:     self.beneficiary = _beneficiary
 25:     self.auctionStart = _auction_start  # auction start time can be in the past, present or future
 26:     self.auctionEnd = self.auctionStart + _bidding_time
 27:     assert block.timestamp &lt; self.auctionEnd # auction end time should be in the future
 28: 
 29: # Bid on the auction with the value sent
 30: # together with this transaction.
 31: # The value will only be refunded if the
 32: # auction is not won.
 33: @external
 34: @payable
 35: def bid():
 36:     # Check if bidding period has started.
 37:     assert block.timestamp &gt;= self.auctionStart
 38:     # Check if bidding period is over.
 39:     assert block.timestamp &lt; self.auctionEnd
 40:     # Check if bid is high enough
 41:     assert msg.value &gt; self.highestBid
 42:     # Track the refund for the previous high bidder
 43:     self.pendingReturns[self.highestBidder] += self.highestBid
 44:     # Track new high bid
 45:     self.highestBidder = msg.sender
 46:     self.highestBid = msg.value
 47: 
 48: # Withdraw a previously refunded bid. The withdraw pattern is
 49: # used here to avoid a security issue. If refunds were directly
 50: # sent as part of bid(), a malicious bidding contract could block
 51: # those refunds and thus block new higher bids from coming in.
 52: @external
 53: def withdraw():
 54:     pending_amount: uint256 = self.pendingReturns[msg.sender]
 55:     self.pendingReturns[msg.sender] = 0
 56:     send(msg.sender, pending_amount)
 57: 
 58: # End the auction and send the highest bid
 59: # to the beneficiary.
 60: @external
 61: def endAuction():
 62:     # It is a good guideline to structure functions that interact
 63:     # with other contracts (i.e. they call functions or send Ether)
 64:     # into three phases:
 65:     # 1. checking conditions
 66:     # 2. performing actions (potentially changing conditions)
 67:     # 3. interacting with other contracts
 68:     # If these phases are mixed up, the other contract could call
 69:     # back into the current contract and modify the state or cause
 70:     # effects (Ether payout) to be performed multiple times.
 71:     # If functions called internally include interaction with external
 72:     # contracts, they also have to be considered interaction with
 73:     # external contracts.
 74: 
 75:     # 1. Conditions
 76:     # Check if auction endtime has been reached
 77:     assert block.timestamp &gt;= self.auctionEnd
 78:     # Check if this function has already been called
 79:     assert not self.ended
 80: 
 81:     # 2. Effects
 82:     self.ended = True
 83: 
 84:     # 3. Interaction
 85:     send(self.beneficiary, self.highestBid)

</code></pre>

<div class="pagebreak"></div>

<pre><code>  1: 
  2: create table accounts (
  3:     account_id    serial not null primary key,
  4:     amount        number
  5: );
  6: 
  7: create or replace function transfer ( p_to int, p_amount number )
  8:     returns text
  9:     as $$
 10: DECLARE
 11:     l_data                    text;
 12: BEGIN
 13:     update accounts
 14:         set amount = amoutn + p_amount
 15:         where acount_id = p_to
 16:         ;
 17:     RETURN l_data;
 18: END;
 19: $$ LANGUAGE plpgsql;
 20: 
 21: 
 22: -- Open Auction
 23: 
 24: -- # Auction params
 25: -- # Beneficiary receives money from the highest bidder
 26: create table open_auction (
 27:     open_auction_id serial not null primary key,
 28:     beneficiary     number,    -- Account Number
 29:     auction_start     timestamp default current_timestamp not null,
 30:     auction_end     timestamp not null,
 31:     highest_bidder     int default 0 not null,
 32:     higest_bid         number default 0 not null,
 33:     ended             boolean default false,
 34:     updated         timestamp,
 35:     created         timestamp default current_timestamp not null
 36: );
 37: 
 38: -- # Keep track of refunded bids so we can follow the withdraw pattern
 39: create table open_auction_bids (
 40:     open_auction_bids_id serial not null primary key,
 41:     open_auction_id     int not null references open_auction ( open_auction_id ),
 42:     bidder                 int default 0 not null,
 43:     bid                 number default 0 not null,
 44:     updated             timestamp,
 45:     created             timestamp default current_timestamp not null
 46: );
 47: 
 48: 
 49: -- # Create the auction at the start
 50: create or replace function setup_auction ( beneficiary int, auction_start timestamp, biding_time int ) 
 51:     returns text
 52:     as $$
 53: DECLARE
 54:     l_data                    text;
 55:     l_ended                    boolean;
 56: BEGIN
 57:     select ended
 58:         into l_ended
 59:         from open_auction 
 60:         ;
 61:     if not found then
 62:         if l_ended then
 63:             update open_auction
 64:                 set 
 65:                     beneficiary = p_benefeciary,
 66:                     auction_start = p_auction_start,
 67:                     auction_end = p_auction_start + interval bidding_time,
 68:                     highest_bidder = 0,
 69:                     higest_bid = 0,
 70:                     ended = false
 71:                 ;
 72:             data = '{&quot;status&quot;:&quot;success&quot;}';
 73:         else
 74:             raise ( 'Auction currently in progress' );
 75:         end if;
 76:     else 
 77:         insert into open_auction ( beneficiary, auction_start, auction_end, highest_bidder, higest_bid, ended )
 78:             values ( p_benefeciary, p_auction_start, p_acution_start + interval bidding_time, 0, false );
 79:         data = '{&quot;status&quot;:&quot;success&quot;}';
 80:     end if;
 81:     RETURN l_data;
 82: END;
 83: $$ LANGUAGE plpgsql;
 84: 
 85:     
 86: 
 87: -- # Bid on the auction with the value sent together with this transaction.
 88: -- # The value will only be refunded if the auction is not won.
 89: create or replace function place_bid ( bid number )
 90:     returns text
 91:     as $$
 92: DECLARE
 93:     l_data                    text;
 94:     l_open_auction_id        int;
 95:     l_bidder                number;
 96:     l_bid                    number;
 97: BEGIN
 98:     
 99:     select bidder, bid
100:         int l_bidder, l_bid
101:         from open_auction_bids
102:         where open_auciton_id = l_open_auction_id
103:           and open_auction_bids_id = (
104:                 select max(open_auction_bids_id)
105:                 from open_auction_bids
106:             );
107:     if not found then
108:         -- this is the first bid, insert
109:         insert into open_auciton_bids_id ( bidder, bid, open_auction_id ) values
110:             ( p_bidder, p_bid, l_open_auction_id );
111:         l_data '{&quot;status&quot;:&quot;bid-accepted&quot;}';
112:     else
113:         if p_bid &gt; l_bid then
114:             insert into open_auciton_bids_id ( bidder, bid, open_auction_id ) values
115:                 ( p_bidder, p_bid, l_open_auction_id );
116:             l_data '{&quot;status&quot;:&quot;bid-accepted&quot;}';
117:         else
118:             l_data '{&quot;status&quot;:&quot;bid-rejected&quot;,&quot;msg&quot;:&quot;not highest bid&quot;}';
119:         end if;
120:     end if;
121: 
122:     RETURN l_data;
123: END;
124: $$ LANGUAGE plpgsql;
125: 
126: 
127: -- # Withdraw a previously refunded bid. The withdraw pattern is
128: -- # used here to avoid a security issue. If refunds were directly
129: -- # sent as part of bid(), a malicious bidding contract could block
130: -- # those refunds and thus block new higher bids from coming in.
131: create or replace function widtraw_funds ( to_acct number ) 
132:     returns text
133:     as $$
134: DECLARE
135:     l_data                    text;
136:     l_highest_bidder        int;
137:     l_highest_bid            number;
138: BEGIN
139: 
140:     select t2.bidder, t2.bid
141:         into l_highest_bidder, l_highest_bid
142:     from open_auction_bids as t2
143:     where t2.open_auction_bids_id = (
144:             select max(open_auction_bids_id)
145:             from open_auction_bids
146:         )
147:         ;
148: 
149:     l_data = '{&quot;status&quot;:&quot;auction still in progress&quot;}';
150:     select 'found' into l_data
151:         from open_auction
152:         where ended = true
153:         ;
154:     if found then
155: 
156:         select transfer ( highest_bidder, l_highest_bid )
157:             int l_data;
158:         l_data = '{&quot;status&quot;:&quot;success&quot;}';
159: 
160:     end if;
161: 
162:     RETURN l_data;
163: END;
164: $$ LANGUAGE plpgsql;
165: 
166: 
167: 
168: -- # End the auction and send the highest bid
169: -- # to the beneficiary.
170: create or replace function end_auction () 
171:     returns text
172:     as $$
173: DECLARE
174:     l_data                    text;
175: BEGIN
176: 
177:     -- Pick out the high bid.  End the auction.
178:     update open_auction as t1
179:         set ended = true
180:             ( highest_bidder, higest_bid ) = ( 
181:                 select t2.bidder, t2.bid
182:                 from open_auction_bids as t2
183:                 where t2.open_auciton_id = t1.open_auction_id
184:                   and t2.open_auction_bids_id = (
185:                         select max(open_auction_bids_id)
186:                         from open_auction_bids
187:                     )
188:             );
189:         where auction_end &gt;= current_timestamp
190:         ;
191: 
192:     -- return bids that were not the highest bid.
193:     select transfer ( t2.bidder, t2.bid )
194:         from open_auction_bids as t2
195:         where t2.open_auction_bids_id &lt; (
196:                 select max(open_auction_bids_id)
197:                 from open_auction_bids
198:             )
199:         ;
200: 
201:     RETURN l_data;
202: END;
203: $$ LANGUAGE plpgsql;
204: 
205: 
206: 

</code></pre>

</div>

